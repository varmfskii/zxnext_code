\section{Z80 CTC}
(3.01.08) Currently does not woprk properly, in particular IM2 still
acts much like the original spectrum interrupt mode.

Eight (currently four) independent CTC channels are available on ports
\$183B through \$1F3B.  These perform counter/timer functions that can
be used to generate timer interrupts or to generate interrupts on
behalf of physical signals.

The CTC is a standard Zilog part.  Its datasheet can be found at
http://www.zilog.com/docs/z80/ps0181.pdf .  The Zilog documentation is
ambiguous around how soft resets are treated so the following
clarifies some points in the Next's implementation.

\begin{enumerate}
\item Hard reset requires both a control word and a time constant to
  be written to a channel even if bit 2 = 0 in the first control word.
\item Soft reset with bit 2 = 0 causes the entire control register to
  be modified.  Soft reset with bit 2 = 1 does not change the control
  register contents.  In both cases a time constant must follow to
  resume operation.
\item Changing the trigger edge selection in bit 4 while the channel
  is in operation counts as a clock edge.  A pending timer trigger
  will be fired and, in counter mode, an edge will be received.
\item ZC/TO is asserted for one clock cycle and not for the entire
  duration that the count is at zero.
\end{enumerate}
At the moment, any interrupt generated by the CTC will assert the
z80's /INT line for 32 cpu cycles.  This is the same way that the ULA
and line interrupts operate.

At the moment, the ZC/TO output of each channel is fed into the
CLK/TRG input of the succeeding channel so that time and count periods
can be cascaded.

\paragraph{Programming}
Initial values are set by a write of a channel control word followed
by a time constant. In timer mode, the counter decrements every time
it is triggered. In counter mode it decrements every time the
prescaler counter reaches zero.

Channel Control Word
\begin{itemize}
\item[] bit 7 = Enable Interrupt
\item[] bit 6 = Mode
  \begin{itemize}
  \item 0 = Timer mode
  \item 1 = Counter mode
  \end{itemize}
\item[] bit 5 = Prescalar value (Timer mode only)
  \begin{itemize}
  \item 0 = 16
  \item 1 = 256
  \end{itemize}
\item[] bit 4 = CLK/TRG edge selection
  \begin{itemize}
  \item 0 = Falling Edge
  \item 1 = Rising Edge
  \end{itemize}
\item[] bit 3 = Timer Trigger (Timer mode only)
  \begin{itemize}
  \item 0 = Starts on loading of time constant
  \item 1 = Starts on CLK/TRG
  \end{itemize}
\item[] bit 2 = Time constant follows
\item[] bit 1 = Software reset
\item[] bit 0 = 0 (Control Word)
\end{itemize}

If we are running at 28MHz (Mode 0) and wish to trigger an interrupt
every 1 sec, that is 28 million T-States/cycles we could program CTC 5
as a counter with a prescalar of 16 and a period of 175, CTC 6 as a
counter with a prescalar of 16 and a period of 125, and CTC 7 as a
timer with a period of 5.

CTC 5 triggers ZC5 every 280 cycles or 10 usec.

CTC 6 triggers ZC6 every 560,000 cycles or 20 msec.

CTC 7 triggers ZC7 and an interrupt every 28,000,000 cycles or 1 sec.

\lstinputlisting{interrupts/ctc.asm}
